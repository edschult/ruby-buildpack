#!/bin/bash

set -eo pipefail

TARGET_DIR=./targets

__parse_arguments() {
  command=${1:-''}
  target_name=$2
  target="$TARGET_DIR/${2}"
  command_name=$0
}

__usage() {
  echo "Usage:"
  echo
  echo "  $command_name build <build-target>"
  echo "  $command_name list"
  exit 1
}

__ensure_trusty_box() {
  vagrant up --provider=vmware_fusion
}

__build() {
  echo "-----> Ensuring vagrant Box is up"
  __ensure_trusty_box

  echo "-----> Running build in docker"
  vagrant ssh -c "sudo docker run -v /vagrant:/dependency-builder -w /dependency-builder cloudfoundry/buildpacks-lucid64 $target $target_name"

  upload_bucket=s3://pivotal-buildpacks
  upload_path=/ruby/binaries/lucid/
  upload_filename=${target_name}.tgz

  echo "-----> Uploading compiled binary (${upload_filename}) to S3"
  bin/gof3r cp out/${upload_filename} ${upload_bucket}${upload_path}${upload_filename}

}

__list() {
  echo "Available targets"
  echo
  ls $TARGET_DIR
}

__check_usage() {
  if [ "$command" == "build" ]; then
    if [ -f $target ]; then
      __build
    else
      echo "ERROR: target definition '$target' not found"
      __list
    fi
  elif [ "$command" == "list" ]; then
    __list
  else
    __usage
  fi
}  

__parse_arguments $@
__check_usage

