#!/bin/bash

set -eo pipefail

TARGET_DIR=./targets

echo "checkpoint 1"

__parse_arguments() {
  target_name=${1:-'__unknown__'}
  target="$TARGET_DIR/${target_name}"
  version=${2:-'__unknown__'}
  patch=${3:-'__unknown__'}
}

__ensure_trusty_box() {
  vagrant up --provider=vmware_fusion
}

__build() {
  echo "-----> Ensuring vagrant Box is up"
  __ensure_trusty_box

  echo "checkpoint 2"


  echo "-----> Running build in docker"
  vagrant ssh -c "sudo docker run -v /vagrant:/dependency-builder -w /dependency-builder cloudfoundry/lucid64_transitional $target $version $patch"

  upload_bucket=s3://pivotal-buildpacks
  upload_path=/ruby/owned/binaries/lucid/
  upload_filename=${target_name}.tgz

  echo "-----> Uploading compiled binary (${upload_filename}) to S3"
  bin/gof3r cp out/${upload_filename} ${upload_bucket}${upload_path}${upload_filename}

}

__list() {
  echo "Available targets"
  echo
  ls $TARGET_DIR
}

__check_usage() {
  if [ -f $target ]; then
    __build
  else
    echo "ERROR: target definition '$target' not found"
    __list
  fi
}  

__parse_arguments $@
__check_usage
